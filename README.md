# Job Scheduler Backend

Lightweight Node/Express backend for scheduling small jobs and sending a completion webhook.

Project layout

- `server.js` - Express app entrypoint
- `config/db.js` - MySQL connection pool (uses top-level await)
- `controllers/jobController.js` - Request handlers
- `models/jobModel.js` - DB queries for `jobs` table
- `routes/jobRoutes.js` - API routes
- `services/webhookService.js` - Sends completion webhook via `axios`
- `scripts/setup_db.js` - Creates database and `jobs` table if missing
- `tests/api_test.js` - Small test script that exercises the APIs
- `.env` - Environment variables (not checked into source)

Prerequisites

- Node.js 16+ recommended (top-level `await` used; Node 18+ or 20+ is fine)
- MySQL server reachable with credentials in `.env`

Quick start

1. Install dependencies

```powershell
npm install
```

2. Ensure `.env` is populated (example below). Then create DB & table:

```powershell
# creates database and jobs table if missing
node scripts/setup_db.js
```

3. Start server

```powershell
npm run start
# server runs on the PORT from .env (default 5000)
```

4. Run the quick API test (optional)

```powershell
node tests/api_test.js
```

.env example

Create a `.env` file in project root with these values (example):

```ini
PORT=5000
DB_HOST=127.0.0.1
DB_USER=root
DB_PASSWORD=yourpassword
DB_NAME=job_scheduler
WEBHOOK_URL=https://webhook.site/<your-id>
```

Database schema (jobs table)

Run the SQL below (or use `node scripts/setup_db.js`):

```sql
CREATE TABLE jobs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  taskName VARCHAR(255),
  payload JSON,
  priority ENUM('Low','Medium','High'),
  status ENUM('pending','running','completed') DEFAULT 'pending',
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

API Endpoints

- Base path: `/api`

1. Create Job

- Method: `POST`
- URL: `/api/jobs`
- Body (application/json):

```json
{
  "taskName": "Send Email",
  "payload": { "email": "test@gmail.com", "subject": "Hello" },
  "priority": "High"
}
```

- Success response (201):

```json
{
  "jobId": 1,
  "message": "Job created successfully"
}
```

Curl example:

```bash
curl -X POST http://localhost:5000/api/jobs \
  -H 'Content-Type: application/json' \
  -d '{"taskName":"Send Email","payload":{"email":"test@gmail.com","subject":"Hello"},"priority":"High"}'
```

2. Get All Jobs

- Method: `GET`
- URL: `/api/jobs`
- Optional query params: `?status=pending` `?priority=High`
- Success: JSON array of job objects (payload is returned as object)

Example:

```bash
curl http://localhost:5000/api/jobs?status=pending&priority=High
```

3. Get Job by ID

- Method: `GET`
- URL: `/api/jobs/:id` (e.g. `/api/jobs/1`)
- Success response:

```json
{
  "id": 1,
  "taskName": "Send Email",
  "payload": { "email": "test@gmail.com", "subject": "Hello" },
  "priority": "High",
  "status": "pending",
  "createdAt": "...",
  "updatedAt": "..."
}
```

4. Run Job

- Method: `POST`
- URL: `/api/run-job/:id` (e.g. `/api/run-job/1`)
- Immediate response: `{ "message": "Job started..." }`
- Background behavior: controller sets job status to `running`, waits ~3 seconds (simulated work), updates status to `completed`, then POSTs a JSON payload to `WEBHOOK_URL`.

Webhook payload (POSTed to `WEBHOOK_URL`):

```json
{
  "jobId": 1,
  "taskName": "Send Email",
  "priority": "High",
  "payload": { "email": "test@gmail.com", "subject": "Hello" },
  "completedAt": "2025-11-25T...Z"
}
```

Notes, caveats and recommendations

- `config/db.js` uses top-level `await` and `type: "module"` in `package.json`. Use Node >=16.8; Node 18+ is recommended.
- The `scripts/setup_db.js` helper will create the database and table if missing. Run it once before using the API if your DB is new.
- The webhook send is fire-and-forget: delivery failures are logged to console but not retried. For production, add retry/backoff and error persistence.
- For production consider replacing the simulated `setTimeout` work with a real worker queue (Bull, Bee-Queue, RabbitMQ) and persistent job states.

Development tips

- Run nodemon in dev (already configured):

```powershell
npm run start
```

- Run the included test script (quick smoke test):

```powershell
node tests/api_test.js
```

Contact / next steps

If you'd like, I can:

- Add a Git commit and branch for these changes.
- Add automated tests (Jest + supertest) for the API.
- Improve webhook reliability (retry + persistent queue).

---

File: `README.md` generated by automation on request.
